<div class="min-h-screen bg-base-200">
  <!-- Навигация -->
  <div class="navbar bg-base-100 shadow-lg">
    <div class="flex-1">
      <a class="btn btn-ghost normal-case text-xl">Панель менеджера</a>
    </div>
    <div class="flex-none">
      <ul class="menu menu-horizontal p-0">
        <li><%= link_to "Обзор", manager_dashboard_path %></li>
        <li><%= link_to "Календарь", manager_calendar_path %></li>
        <li><%= link_to "Столы", manager_tables_path %></li>
        <li><%= link_to "Бронирования", manager_bookings_path, class: "active" %></li>
      </ul>
    </div>
  </div>

  <div class="container mx-auto px-4 py-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
      <h1 class="text-3xl font-bold">Все бронирования</h1>
      
      <!-- Форма поиска и настроек -->
      <%= form_with url: manager_bookings_path, method: :get, class: "flex flex-col sm:flex-row gap-2 w-full lg:w-auto" do |form| %>
        <%= text_field_tag :search, params[:search], placeholder: "Поиск по номеру, клиенту, email, телефону", class: "input input-bordered input-sm w-full sm:w-auto" %>
        
        <div class="form-control">
          <select id="per-page" name="per_page" class="select select-bordered select-sm">
            <option value="10" <%= 'selected' if params[:per_page].to_i == 10 %>>10</option>
            <option value="20" <%= 'selected' if params[:per_page].to_i == 20 || params[:per_page].nil? %>>20</option>
            <option value="50" <%= 'selected' if params[:per_page].to_i == 50 %>>50</option>
            <option value="100" <%= 'selected' if params[:per_page].to_i == 100 %>>100</option>
          </select>
        </div>

        <%= form.submit "Найти", class: "btn btn-primary btn-sm" %>
        <%= link_to "Сброс", manager_bookings_path, class: "btn btn-ghost btn-sm" %>
      <% end %>
    </div>

    <div class="bg-base-100 rounded-lg shadow-lg p-6">
      <div class="overflow-x-auto">
        <table class="table table-compact w-full">
          <thead>
            <tr>
              <th><%= sort_link('booking_number', 'Номер') %></th>
              <th><%= sort_link('users.full_name', 'Клиент') %></th>
              <th>Места / Столы</th>
              <th><%= sort_link('starts_at', 'Дата и время') %></th>
              <th><%= sort_link('status', 'Статус') %></th>
              <th>Стоимость</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            <% @bookings.each do |booking| %>
              <tr>
                <td><%= booking.booking_number %></td>
                <td>
                  <div class="font-semibold"><%= booking.user&.full_name || "Неизвестный" %></div>
                  <div class="text-xs text-base-content/70"><%= booking.user&.email %></div>
                  <div class="text-xs text-base-content/70"><%= format_phone_number(booking.user&.phone) %></div>
                </td>
                <td>
                  <% if booking.seats.any? %>
                    <%# Группируем места по столам для корректного отображения %>
                    <% seats_by_table = booking.seats.includes(:table).group_by(&:table) %>
                    <% seats_by_table.each do |table, seats| %>
                      <% if table %>
                        <%# Если забронированы все места за столом %>
                        <% if seats.count == table.seats.count %>
                          <span class="badge badge-outline badge-lg">Стол <%= table.name %></span>
                        <%# Если забронирована часть мест %>
                        <% else %>
                          <span class="badge badge-outline badge-lg">Стол <%= table.name %> (места: <%= seats.map(&:number).join(', ') %>)</span>
                        <% end %>
                      <% else %>
                        <%# Если места не привязаны к столу %>
                        <% seats.each do |seat| %>
                          <span class="badge badge-outline">М<%= seat.number %></span>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% else %>
                    <span class="badge badge-outline">Нет данных</span>
                  <% end %>
                </td>
                <td>
                  <div class="font-semibold"><%= l(booking.starts_at, format: '%d %B %Y') %></div>
                  <div class="text-sm text-base-content/70">
                    c <%= booking.starts_at.strftime('%H:%M') %> до <%= booking.ends_at.strftime('%H:%M') %>
                  </div>
                </td>
                <td>
                  <% status_info = get_status_info(booking.status) %>
                  <div class="badge <%= status_info[:color] %>">
                    <%= status_info[:text] %>
                  </div>
                </td>
                <td>
                  <div class="text-sm">
                    <div class="font-semibold">Итого: <%= number_to_currency(booking.total_price + (booking.order&.total_amount || 0), unit: "BYN", format: "%n %u") %></div>
                    <div class="text-xs text-base-content/70">
                      Бронь: <%= number_to_currency(booking.total_price, unit: "BYN", format: "%n %u") %>
                    </div>
                    <% if booking.order&.total_amount && booking.order.total_amount > 0 %>
                      <div class="text-xs text-base-content/70">
                        Заказ: <%= number_to_currency(booking.order.total_amount, unit: "BYN", format: "%n %u") %>
                      </div>
                    <% end %>
                  </div>
                </td>
                <td>
                  <div class="flex gap-1">
                    <%= link_to "Детали", manager_booking_path(booking), class: "btn btn-ghost btn-xs", target: "_blank", rel: "noopener noreferrer" %>
                    <%= link_to "Редактировать", edit_manager_booking_path(booking), class: "btn btn-ghost btn-xs" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <!-- Пагинация -->
      <div class="flex flex-col items-center mt-6">
        <div class="text-sm text-base-content/70 mb-4">
          <% if @bookings.respond_to?(:current_page_record_count) %>
            Показано <%= @bookings.offset_value + 1 %> - <%= [@bookings.offset_value + @bookings.current_page_record_count, @bookings.total_count].min %> из <%= @bookings.total_count %> записей
          <% end %>
        </div>
        <%= render 'custom_pagination', bookings: @bookings %>
      </div>
    </div>
  </div>
</div>
