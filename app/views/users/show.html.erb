<div class="min-h-screen from-base-200 to-base-300 py-8 px-4">
  <div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-base-content mb-2">Ваш профиль</h1>
      <p class="text-base-content/70 text-lg">Управление вашими личными данными</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1">
        <div class="card bg-base-100 shadow-xl h-full">
          <div class="card-body">
            <div class="mb-4">
              <%= link_to root_path, class: "btn btn-circle btn-ghost text-base-content/70 hover:text-base-content" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
              <% end %>
            </div>

            <div class="text-center">
              <div class="avatar">
                <div class="w-24 rounded-full bg-primary/10 p-1 mx-auto mb-4">
                  <div class="w-full h-full rounded-full bg-primary/10 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                  </div>
                </div>
              </div>
              <h2 class="text-2xl font-bold"><%= @user.full_name %></h2>
              <p class="text-base-content/70 mt-1"><%= @user.email %></p>

              <div class="mt-3">
                <% if @user.confirmed? %>
                  <div class="badge badge-success gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Email подтвержден
                  </div>
                <% else %>
                  <div class="badge badge-warning gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    Email не подтвержден
                  </div>
                <% end %>
              </div>
              
              <div class="divider my-4"></div>
              
              <div class="text-left space-y-2">
                <div class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  <span class="text-sm"><%= @user.formatted_phone %></span>
                </div>
                <div class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-sm">Зарегистрирован: <%= l(@user.created_at, format: :short) %></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h3 class="card-title text-xl mb-6">Редактирование профиля</h3>

            <%= form_with model: @user, url: profile_path, method: :patch, class: "space-y-6", data: { turbo: false } do |f| %>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text font-medium">Фамилия</span>
                    <span class="label-text-alt text-error">*</span>
                  </label>
                  <%= f.text_field :last_name, class: "input input-bordered w-full", required: true %>
                  <% if @user.errors[:last_name].any? %>
                    <label class="label">
                      <span class="label-text-alt text-error"><%= @user.errors[:last_name].first %></span>
                    </label>
                  <% end %>
                </div>

                <div class="form-control">
                  <label class="label">
                    <span class="label-text font-medium">Имя</span>
                    <span class="label-text-alt text-error">*</span>
                  </label>
                  <%= f.text_field :first_name, class: "input input-bordered w-full", required: true %>
                  <% if @user.errors[:first_name].any? %>
                    <label class="label">
                      <span class="label-text-alt text-error"><%= @user.errors[:first_name].first %></span>
                    </label>
                  <% end %>
                </div>

                <div class="form-control">
                  <label class="label">
                    <span class="label-text font-medium">Отчество</span>
                  </label>
                  <%= f.text_field :middle_name, class: "input input-bordered w-full" %>
                  <% if @user.errors[:middle_name].any? %>
                    <label class="label">
                      <span class="label-text-alt text-error"><%= @user.errors[:middle_name].first %></span>
                    </label>
                  <% end %>
                </div>
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">Телефон</span>
                  <span class="label-text-alt text-error">*</span>
                </label>
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                  </div>
                  <%= f.text_field :phone,
                        id: "phone",
                        class: "input input-bordered w-full pl-10 font-mono tracking-widest #{@user.errors[:phone].any? ? 'input-error' : ''}",
                        placeholder: "+375 (__) ___-__-__",
                        autocomplete: "tel",
                        inputmode: "tel",
                        required: true,
                        value: format_phone_number(@user.phone) %>
                </div>
                <% if @user.errors[:phone].any? %>
                  <label class="label">
                    <span class="label-text-alt text-error"><%= @user.errors[:phone].first %></span>
                  </label>
                <% end %>
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">Email</span>
                </label>
                <div class="flex gap-2">
                  <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                    </div>
                    <input type="email" 
                           value="<%= @user.email %>" 
                           class="input input-bordered w-full pl-10 bg-base-200" 
                           readonly 
                           disabled>
                  </div>
                  <%= link_to "Изменить email", 
                        email_confirmation_path,
                        class: "btn btn-outline"
                  %>
                </div>
              </div>

              <% unless @user.confirmed? %>
                <div class="rounded-md px-3 py-2 flex items-center justify-between gap-3 bg-primary/10 border border-primary/20">
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 А" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12A9 9 0 1112 3a9 9 0 019 9z"/>
                    </svg>
                    <span class="text-sm text-primary">Email не подтвержден — подтвердите для полного доступа</span>
                  </div>

                  <div class="flex-none">
                    <%= link_to "Подтвердить", email_verification_path, class: "btn btn-xs btn-primary" %>
                  </div>
                </div>
              <% end %>

              <div class="flex gap-3 pt-4">
                <%= f.submit "Сохранить изменения", class: "btn btn-primary flex-1" %>
                <%= link_to "Отмена", profile_path, class: "btn btn-ghost" %>
              </div>
            <% end %>

            <div class="divider"></div>
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div class="flex flex-wrap gap-2">
                <%= link_to "Сменить пароль", password_change_path, class: "btn btn-sm btn-outline" %>
                <%= button_to "Выйти из аккаунта", 
                      logout_path, 
                      method: :delete, 
                      class: "btn btn-sm btn-ghost text-error",
                      form: { class: "inline", data: { turbo_confirm: "Вы уверены, что хотите выйти?" } } %>
              </div>
              <div>
                <button onclick="deleteAccountModal.showModal()" class="btn btn-sm btn-error">
                  Удалить аккаунт
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <dialog id="deleteAccountModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Удаление аккаунта</h3>
      <p class="py-4">Вы уверены, что хотите удалить свой аккаунт? Это действие необратимо и приведет к потере всех ваших данных.</p>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">Отмена</button>
        </form>
        <%= button_to "Удалить аккаунт", 
              delete_account_path, 
              method: :delete, 
              class: "btn btn-error",
              form: { data: { turbo_confirm: "Это действие необратимо. Вы действительно хотите удалить свой аккаунт?" } } %>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    
    alerts.forEach(alert => {
      setTimeout(() => {
        alert.style.transition = 'opacity 0.5s ease-in-out';
        alert.style.opacity = '0';
        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 500);
      }, 5000);
    });
  });

  function initializePhoneMask() {
    const phoneInput = document.getElementById('phone');
    if (!phoneInput) return;

    const mask = '+375 (__) ___-__-__';

    function applyMask(value) {
      let digits = value.replace(/\D/g, '');
      if (!digits.startsWith('375')) {
        digits = '375' + digits;
      }
      digits = digits.slice(0, 12);
      const number = digits.slice(3);

      const operator = number.slice(0, 2).padEnd(2, '_');
      const firstPart = number.slice(2, 5).padEnd(3, '_');
      const secondPart = number.slice(5, 7).padEnd(2, '_');
      const thirdPart = number.slice(7, 9).padEnd(2, '_');

      return `+375 (${operator}) ${firstPart}-${secondPart}-${thirdPart}`;
    }

    const digitToIndexMap = [7, 8, 11, 12, 13, 15, 16, 18, 19];

    function getCursorPositionAfterInsertion(oldValue, newValue, oldPos) {
      if (oldValue === newValue) return oldPos;
      const digitsBeforeCursor = oldValue.substring(0, oldPos).replace(/\D/g, '').length;
      if (digitsBeforeCursor <= 3) return 6;
      const digitIndexInNumber = digitsBeforeCursor - 4;
      const newPos = digitToIndexMap[digitIndexInNumber] + 1;
      return newPos || newValue.length;
    }

    function getCursorPositionAfterDeletion(oldPos) {
      if (oldPos <= 6) return 6;
      
      let digitIndexToDelete = -1;
      let currentDigitPos = 0;
      for (let i = 0; i < phoneInput.value.length; i++) {
        if (/\d/.test(phoneInput.value[i])) {
          if (i === oldPos - 1) {
            digitIndexToDelete = currentDigitPos;
            break;
          }
          currentDigitPos++;
        }
      }

      if (digitIndexToDelete > 3) {
        const newCursorIndex = digitToIndexMap[digitIndexToDelete - 4];
        return newCursorIndex;
      }
      
      return oldPos - 1;
    }

    phoneInput.addEventListener('input', function(e) {
      if (e.inputType && e.inputType.startsWith('delete')) {
        return;
      }

      const oldValue = phoneInput.value;
      const cursorPos = phoneInput.selectionStart;
      
      phoneInput.value = applyMask(phoneInput.value);
      
      const newPos = getCursorPositionAfterInsertion(oldValue, phoneInput.value, cursorPos);
      phoneInput.setSelectionRange(newPos, newPos);
    });

    phoneInput.addEventListener('keydown', function(e) {
      const cursorPos = phoneInput.selectionStart;
      const endPos = phoneInput.selectionEnd;
      const key = e.key;

      if (['ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End', 'Enter'].includes(key)) {
        return;
      }

      if (key === 'Backspace' || key === 'Delete') {
        if (cursorPos !== endPos) return;

        if (cursorPos <= 6) {
          e.preventDefault();
          return;
        }

        e.preventDefault();

        const allDigits = phoneInput.value.replace(/\D/g, '');
        
        let digitIndexToDelete = -1;
        let currentDigitPos = 0;
        for (let i = 0; i < phoneInput.value.length; i++) {
          if (/\d/.test(phoneInput.value[i])) {
            const isTarget = (key === 'Backspace' && i === cursorPos - 1) || (key === 'Delete' && i === cursorPos);
            if (isTarget) {
              digitIndexToDelete = currentDigitPos;
              break;
            }
            currentDigitPos++;
          }
        }
        
        if (digitIndexToDelete > -1) {
          const newDigits = allDigits.slice(0, digitIndexToDelete) + allDigits.slice(digitIndexToDelete + 1);
          phoneInput.value = applyMask(newDigits);
          
          let newCursorPos;
          if (digitIndexToDelete <= 3) {
            newCursorPos = 6;
          } else {
            const indexInNumber = digitIndexToDelete - 4;
            newCursorPos = digitToIndexMap[indexInNumber];
          }
          phoneInput.setSelectionRange(newCursorPos, newCursorPos);
        } else {
          const newPos = key === 'Backspace' ? cursorPos - 1 : cursorPos + 1;
          phoneInput.setSelectionRange(newPos, newPos);
        }
      }
    });

    phoneInput.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedData = (e.clipboardData || window.clipboardData).getData('text');
      const digits = pastedData.replace(/\D/g, '');
      phoneInput.value = applyMask(digits);
      phoneInput.setSelectionRange(phoneInput.value.length, phoneInput.value.length);
    });

    function handleCursorFocus(e) {
      const cursorPos = phoneInput.selectionStart;
      if (cursorPos < 6) {
        phoneInput.setSelectionRange(6, 6);
      }
    }

    phoneInput.addEventListener('click', handleCursorFocus);
    phoneInput.addEventListener('focus', handleCursorFocus);
  }

  document.addEventListener('DOMContentLoaded', function() {
    initializePhoneMask();

    const form = document.querySelector('form[data-turbo="false"]');
    
    if (form) {
      form.addEventListener('submit', function(e) {
        const phoneInput = document.getElementById('phone');
        
        if (phoneInput) {
          const phoneValue = phoneInput.value;
          const digits = phoneValue.replace(/\D/g, '');

          if (digits.startsWith('375')) {
            phoneInput.value = digits.substring(3);
          } else {
            phoneInput.value = digits;
          }
        }
      });
    }
  });
  
  document.addEventListener('turbo:load', initializePhoneMask);
</script>
