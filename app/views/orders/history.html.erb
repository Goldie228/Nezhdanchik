<div class="min-h-screen bg-base-200">
  <div class="container mx-auto px-4 py-4 md:py-8">
    <!-- Хлебные крошки -->
    <div class="text-sm breadcrumbs mb-4 md:mb-6">
      <ul>
        <li><a href="/" class="text-primary hover:text-primary-focus">Главная</a></li>
        <li><span class="text-base-content/60">История бронирований</span></li>
      </ul>
    </div>

    <!-- Заголовок страницы -->
    <div class="card bg-base-100 shadow-xl mb-6 md:mb-8">
      <div class="card-body">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="card-title text-2xl md:text-3xl font-bold text-primary mb-2">
              История бронирований
            </h1>
            <p class="text-base-content/70">
              Здесь вы можете просмотреть все ваши предыдущие бронирования и заказы
            </p>
          </div>
          <div class="stats shadow">
            <div class="stat">
              <div class="stat-title">Всего бронирований</div>
              <div class="stat-value text-primary"><%= @all_bookings.count %></div>
              <div class="stat-desc">За все время</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ЕДИНЫЙ СПИСОК ВСЕХ БРОНИРОВАНИЙ -->
    <% if @all_bookings.any? %>
      <div class="space-y-6">
        <% @all_bookings.each do |booking| %>
          <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300">
            <div class="card-body p-4 md:p-6">
              <!-- Шапка с информацией о бронировании -->
              <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                <div class="flex items-center gap-4">
                  <div class="flex flex-col">
                    <span class="text-sm text-base-content/60">Номер брони</span>
                    <span class="text-lg font-bold text-primary"><%= booking.booking_number %></span>
                    <% if booking.order %>
                      <span class="text-xs text-base-content/50">(Заказ №<%= booking.order.order_number %>)</span>
                    <% end %>
                  </div>
                  <div class="flex flex-col">
                    <span class="text-sm text-base-content/60">Дата и время</span>
                    <span class="font-semibold">
                      <%= booking.starts_at.strftime('%d.%m.%Y') %> с 
                      <%= booking.starts_at.strftime('%H:%M') %> до 
                      <%= booking.ends_at.strftime('%H:%M') %>
                    </span>
                  </div>
                </div>
                
                <div class="flex items-center gap-4">
                  <div class="flex flex-col text-right">
                    <span class="text-sm text-base-content/60">Места</span>
                    <span class="font-semibold">
                      <%# Группируем места по столам для правильного отображения %>
                      <% seats_by_table = booking.seats.group_by(&:table_id) %>
                      
                      <% seats_by_table.each_with_index do |(table_id, seats), index| %>
                        <% if index > 0 %>, <% end %>
                        
                        <% if table_id.present? %>
                          <%# Если это стол, показываем его название %>
                          Стол <%= seats.first.table.name %>
                          <span class="text-xs text-base-content/60">
                            (<%= seats.map(&:number).join(', ') %>)
                          </span>
                        <% else %>
                          <%# Если это отдельные места без стола %>
                          <%= seats.map(&:number).join(', ') %>
                        <% end %>
                      <% end %>
                    </span>
                  </div>
                  <div class="badge badge-lg <%= status_badge_class(booking.status) %>">
                    <%= status_in_russian(booking.status) %>
                  </div>
                </div>
              </div>

              <div class="divider my-2"></div>

              <!-- БЛОК С ТОВАРАМИ: ОСНОВНАЯ ЛОГИКА -->
              <%# Если есть финальный заказ, берем товары оттуда %>
              <% if booking.order && booking.order.order_items.any? %>
                <h4 class="text-sm font-semibold text-base-content/70 mb-3">Состав заказа:</h4>
                <div class="space-y-3">
                  <% booking.order.order_items.includes(:dish).limit(3).each do |item| %>
                    <div class="flex items-center gap-4 p-3 bg-base-200 rounded-xl">
                      <figure class="w-16 h-16 rounded-xl overflow-hidden flex-shrink-0 bg-base-300 flex items-center justify-center">
                        <% if item.dish.photos.attached? %>
                          <%= image_tag url_for(item.dish.photos.first), class: "w-full h-full object-cover" %>
                        <% else %>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                        <% end %>
                      </figure>
                      <div class="flex-1 min-w-0">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                          <div>
                            <h3 class="font-semibold text-base truncate"><%= item.dish.title %></h3>
                            <!-- Добавляем отображение добавок и удалений -->
                            <% if item.special_instructions.present? %>
                              <div class="text-xs text-base-content/60 mt-1">
                                <%= item.special_instructions %>
                              </div>
                            <% end %>
                          </div>
                          <div class="flex items-center gap-4">
                            <span class="text-base-content/70">
                              <%= item.quantity %> × <%= number_to_currency(item.unit_price, unit: "BYN", format: "%n %u") %>
                            </span>
                            <span class="font-semibold text-primary">
                              <%= number_to_currency(item.total_price, unit: "BYN", format: "%n %u") %>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                  <% if booking.order.order_items.count > 3 %>
                    <div class="text-center text-base-content/60">... и еще <%= booking.order.order_items.count - 3 %> товаров</div>
                  <% end %>
                </div>

              <%# Иначе, если заказа еще нет, берем товары из корзины %>
              <% elsif booking.cart && booking.cart.cart_items.any? %>
                <h4 class="text-sm font-semibold text-base-content/70 mb-3">Товары в корзине:</h4>
                <div class="space-y-3">
                  <% booking.cart.cart_items.includes(:dish, :cart_item_ingredients).limit(3).each do |item| %>
                    <div class="flex items-center gap-4 p-3 bg-base-200 rounded-xl">
                      <figure class="w-16 h-16 rounded-xl overflow-hidden flex-shrink-0 bg-base-300 flex items-center justify-center">
                        <% if item.dish.photos.attached? %>
                          <%= image_tag url_for(item.dish.photos.first), class: "w-full h-full object-cover" %>
                        <% else %>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                        <% end %>
                      </figure>
                      <div class="flex-1 min-w-0">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                          <div>
                            <h3 class="font-semibold text-base truncate"><%= item.dish.title %></h3>
                            <!-- Добавляем отображение добавок и удалений -->
                            <% if generate_special_instructions(item).present? %>
                              <div class="text-xs text-base-content/60 mt-1">
                                <%= generate_special_instructions(item) %>
                              </div>
                            <% end %>
                          </div>
                          <div class="flex items-center gap-4">
                            <span class="text-base-content/70">
                              <%= item.quantity %> × <%= number_to_currency(item.dish.price, unit: "BYN", format: "%n %u") %>
                            </span>
                            <span class="font-semibold text-primary">
                              <%= number_to_currency(item.quantity * item.dish.price, unit: "BYN", format: "%n %u") %>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                  <% if booking.cart.cart_items.count > 3 %>
                    <div class="text-center text-base-content/60">... и еще <%= booking.cart.cart_items.count - 3 %> товаров</div>
                  <% end %>
                </div>
              <% else %>
                <p class="text-center text-base-content/70 py-4">К этому бронированию не добавлено товаров.</p>
              <% end %>

              <!-- Действия -->
              <div class="card-actions justify-end mt-4">
                <%= link_to "Детали", order_path(booking.id), class: "btn btn-outline btn-sm" %>
                <% if booking.status == 'confirmed' %>
                  <%= link_to "Отменить", cancel_reservation_path(booking), 
                      method: :delete, 
                      data: { confirm: "Вы уверены, что хотите отменить бронирование?" },
                      class: "btn btn-error btn-sm" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <!-- Пустая история -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body text-center py-12">
          <div class="flex justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-base-content/70 mb-2">История пуста</h3>
          <p class="text-base-content/60 mb-6">У вас пока нет ни одного бронирования</p>
          <%= link_to "Сделать бронирование", reservation_path, class: "btn btn-primary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>
